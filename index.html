<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scepter</title>
</head>
<body>
    <h1></h1>
    <main>
        <section>
        </section>
        <button id="newEntryBtn">New entry</button>
    </main>

    <script>
        const titleNode = document.querySelector('h1');
        titleNode.innerText = (new Date()).toString();

        // Load initial state from URL
        // const asciiData = window.location.hash.slice(1)
        // const decodedJsonStr = atob(asciiData)
        // const obj = JSON.parse(decodedJsonStr)
        const entries = []

        const section = document.querySelector('section')

        // Add initial entries to DOM
        // TODO: might be faster to `append` all nodes in batch
        entries.forEach(entry => {
            section.appendChild(makeForm(entry))
        })

        // Attach event listener to newEntryBtn
        document.getElementById('newEntryBtn').addEventListener('click', event => {
            const lastRank = parseInt(entries.slice(-1) && entries.slice(-1)[0] && entries.slice(-1)[0].rank)
            const newEntry = {
                title: '',
                completed: false,
                rank: lastRank ? lastRank + 100 : 0,
            }
            const el = makeForm(newEntry)
            section.appendChild(el)
            el.querySelector('[type="text"]').focus()

            entries.push(newEntry)
        })

        // Returns a new <form> representing an entry
        function makeForm(entry) {
            const { title, completed, rank } = entry;
            const el = document.createElement('form')
            const id = rndID()
            entry.id = id;
            el.setAttribute('id', id)
            el.setAttribute('autocomplete', 'off')
            el.innerHTML = `
                <input name="completed" type="checkbox" ${completed ? 'checked' : ''} />
                <input name="title" type="text" value="${title}" />
            `
            el.querySelector('[name="completed"]').addEventListener('change', event => {
                const { checked, form } = event.target
                entries.find(x => x.id == form.id).completed = checked
                serialize()
            })
            el.querySelector('[name="title"]').addEventListener('change', event => {
                const { value, form } = event.target
                entries.find(x => x.id == form.id).title = value
                serialize()
            })
            el.addEventListener('submit', event => {
                event.preventDefault() // don't submit when pressing enter
            })
            return el
        }

        // Returns a random, 6 characters alphanumeric string
        function rndID() {
            return Math.random().toString(18).substring(2, 5) + Math.random().toString(18).substring(2, 5)
        }

        // Appends serialized app state to URL
        function serialize() {
            const jsonStr = JSON.stringify(entries)
            history.pushState(null, '', '#' + btoa(jsonStr))
        }
    </script>
    <link rel="stylesheet" href="style.css">
</body>
</html>